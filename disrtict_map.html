<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>What's my Council District?</title>
		<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<link
			href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
			rel="stylesheet" />
		<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.3.0/turf.min.js"></script>
		<style>
			body {
				padding: 0px;
			}
			#suggestions {
				list-style-type: none;
				padding: 0;
				margin: 0;
				position: absolute;
				background-color: white;
				border: 1px solid #ccc;
				z-index: 1000;
			}
			#suggestions li {
				padding: 8px;
				cursor: pointer;
			}
			#suggestions li:hover {
				background-color: #eee;
			}
			#map {
				height: calc(100vh - 60px);
			}
			.district-tooltip {
				background: none !important;
				border: none !important;
				box-shadow: none !important;
				font-weight: bold;
				font-size: 14px;
				color: #646486;
			}

			.council-link {
				margin: 5px 0;
				display: flex;
				align-items: center;
			}
			.council-link img {
				height: 30px;
				margin-right: 10px;
				font-size: 18px;
			}
			.council-link .map-widget-title {
				font-family: 'Arial', sans-serif;
			}
			.form-group {
				position: absolute;
				top: 20px;
				left: 50%;
				transform: translateX(-50%);
				width: 95%;
				z-index: 1000;
				margin-left: 20px;
			}
			.map-widget-title {
				margin-left: -7.5em;
				margin-top: 12px;
				font-size: 14px;
				font-weight: bold;
			}

			.header .map-widget-title {
				z-index: 1001;
			}
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<div class="header">
				<a
					href="http://council.nyc.gov/districts/"
					target="_blank"
					class="council-link"
					style="color: #3057a6">
					<img
						src="https://council.nyc.gov/wp-content/themes/wp-nycc/assets/images/nyc-seal-blue.png"
						alt="NYC Council Logo" />
					New York City Council<br />
					<span class="map-widget-title sans-serif"
						><br /><em>Find My District</em></span
					>
				</a>
			</div>

			<div id="map">
				<div class="form-group">
					<input
						type="text"
						class="form-control"
						id="address-input"
						placeholder="Street Address, Borough" />
					<ul id="suggestions"></ul>
				</div>
			</div>
		</div>

		<script>
			$(document).ready(function () {
				let map = L.map('map').setView([40.7128, -74.006], 11);
				L.tileLayer(
					'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
					{
						attribution:
							'&copy; <a href="https://carto.com/attributions">CARTO</a>',
						subdomains: 'abcd',
						maxZoom: 19,
					}
				).addTo(map);

				// Add the council district boundaries GeoJSON layer
				let council_geojson_url =
					'https://services5.arcgis.com/GfwWNkhOj9bNBqoJ/arcgis/rest/services/NYC_City_Council_Districts/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=geojson';
				$.getJSON(council_geojson_url, function (data) {
					L.geoJSON(data, {
						style: function (feature) {
							return {
								color: '#00008B',
								weight: 2,
								opacity: 0.2,
								// fillColor: 'SkyBlue',
								fillOpacity: 0,
							};
						},
						onEachFeature: function (feature, layer) {
							// Calculate centroid
							let centroid = layer.getBounds().getCenter();
							let districtNumber = feature.properties.CounDist;
							L.marker(centroid, {
								icon: L.divIcon({
									className: 'district-tooltip',
									html: `<div>${districtNumber}</div>`,
								}),
							}).addTo(map);
						},
					}).addTo(map);
				});

				let marker;

				$('#address-input').on('input', function () {
					let query = $(this).val();
					if (query.length >= 3) {
						$.getJSON(
							`https://geosearch.planninglabs.nyc/v2/autocomplete?text=${query}`,
							function (data) {
								$('#suggestions').empty();
								data.features.forEach(function (item) {
									$('#suggestions').append(`<li>${item.properties.label}</li>`);
								});
							}
						);
					} else {
						$('#suggestions').empty();
					}
				});

				$('#suggestions').on('click', 'li', function () {
					let address = $(this).text();
					$('#address-input').val(address);
					$('#suggestions').empty();
					$.getJSON(
						`https://geosearch.planninglabs.nyc/v2/search?text=${address}`,
						function (data) {
							if (data.features.length) {
								const feature = data.features[0];
								const lat = feature.geometry.coordinates[1];
								const lon = feature.geometry.coordinates[0];
								const properties = feature.properties;

								// Fetch council district information
								const soda_url =
									'https://data.cityofnewyork.us/resource/s2hu-y8ab.json';
								$.getJSON(soda_url, function (soda_data) {
									const point = {
										type: 'Point',
										coordinates: [lon, lat],
									};

									let council_district = 'N/A';
									soda_data.forEach(function (feature) {
										const geom = feature.the_geom;
										if (turf.booleanPointInPolygon(point, geom)) {
											council_district = feature.coun_dist;
										}
									});

									properties.council_district = council_district;

									if (marker) {
										map.removeLayer(marker);
									}
									map.setView([lat, lon], 12);
									marker = L.marker([lat, lon])
										.addTo(map)
										.bindPopup(
											`<b>${properties.label}</b><br>${properties.borough}<br>Council District: ${properties.council_district}`
										)
										.openPopup();
								});
							}
						}
					);
				});
			});
		</script>
	</body>
</html>
